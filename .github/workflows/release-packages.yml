name: Release Packages

on:
  release:
    types:
      - published
  workflow_run:
    workflows: ["Release"]
    types:
      - completed
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (branch/tag) to build packages from"
        required: true
        default: master
      release_tag:
        description: "Existing release tag to attach rebuilt assets to"
        required: true

permissions:
  contents: write

env:
  DEBIAN_FRONTEND: noninteractive
  RPMBUILD_TOPDIR: /tmp/rpmbuild

defaults:
  run:
    shell: bash

jobs:
  resolve-tag:
    name: Resolve release tag
    runs-on: ubuntu-latest
    if: github.event_name != 'workflow_run' || github.event.workflow_run.conclusion == 'success'
    outputs:
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || '' }}

      - name: Determine tag
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            echo "tag=${{ github.event.release.tag_name }}" >> "$GITHUB_OUTPUT"
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "tag=${{ inputs.release_tag }}" >> "$GITHUB_OUTPUT"
          else
            ver=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
            echo "tag=v${ver}" >> "$GITHUB_OUTPUT"
          fi

      - name: Verify release exists
        run: gh release view "${{ steps.tag.outputs.tag }}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  detect-versions:
    name: Detect distro versions
    needs: resolve-tag
    runs-on: ubuntu-latest
    outputs:
      ubuntu_stable: ${{ steps.detect.outputs.ubuntu_stable }}
      ubuntu_lts: ${{ steps.detect.outputs.ubuntu_lts }}
      debian_stable: ${{ steps.detect.outputs.debian_stable }}
      debian_oldstable: ${{ steps.detect.outputs.debian_oldstable }}
      fedora_release: ${{ steps.detect.outputs.fedora_release }}
      rocky_release: ${{ steps.detect.outputs.rocky_release }}
      rocky_previous: ${{ steps.detect.outputs.rocky_previous }}
      rocky_latest: ${{ steps.detect.outputs.rocky_latest }}
      rocky_container_previous: ${{ steps.detect.outputs.rocky_container_previous }}
      rocky_container_latest: ${{ steps.detect.outputs.rocky_container_latest }}
      rocky_releases: ${{ steps.detect.outputs.rocky_releases }}
      opensuse_leap: ${{ steps.detect.outputs.opensuse_leap }}
      suse_bci: ${{ steps.detect.outputs.suse_bci }}
      alpine_release: ${{ steps.detect.outputs.alpine_release }}
    steps:
      - name: Fetch latest distro versions
        id: detect
        run: |
          set -euo pipefail
          python - <<'PY'
          import os
          import urllib.request
          import json
          import re

          def fetch_text(url):
              with urllib.request.urlopen(url, timeout=10) as resp:
                  return resp.read().decode()

          def latest_ubuntu_non_lts():
              try:
                  data = fetch_text("https://changelogs.ubuntu.com/meta-release")
                  versions = []
                  block = {}
                  for line in data.splitlines() + [""]:
                      if not line.strip():
                          if block.get("Supported") == "1" and block.get("Lts", "0") == "0" and "Version" in block:
                              versions.append(block["Version"])
                          block = {}
                          continue
                      if ":" in line:
                          k, v = line.split(":", 1)
                          block[k.strip()] = v.strip()
                  if versions:
                      return versions[-1]
              except Exception:
                  pass
              return "latest"

          def latest_ubuntu_lts():
              try:
                  data = fetch_text("https://changelogs.ubuntu.com/meta-release-lts")
                  versions = []
                  block = {}
                  for line in data.splitlines() + [""]:
                      if not line.strip():
                          if block.get("Supported") == "1" and block.get("Lts") == "1" and "Version" in block:
                              versions.append(block["Version"])
                          block = {}
                          continue
                      if ":" in line:
                          k, v = line.split(":", 1)
                          block[k.strip()] = v.strip()
                  if versions:
                      return versions[-1]
              except Exception:
                  pass
              return "22.04"

          def debian_codename(track):
              url = f"https://deb.debian.org/debian/dists/{track}/Release"
              try:
                  data = fetch_text(url)
                  for line in data.splitlines():
                      if line.startswith("Codename:"):
                          return line.split(":", 1)[1].strip()
              except Exception:
                  pass
              return track

          def latest_fedora_release():
              try:
                  data = fetch_text("https://getfedora.org/releases.json")
                  releases = json.loads(data)
                  versions = []
                  for entry in releases.get("fedora", []):
                      ver = entry.get("version")
                      status = entry.get("status")
                      edition = entry.get("edition")
                      if edition == "Everything" and status == "Active" and ver is not None:
                          versions.append(int(ver))
                  if versions:
                      return str(max(versions))
              except Exception:
                  pass
              return "39"

          def rocky_version_list():
              versions = []
              try:
                  html = fetch_text("https://dl.rockylinux.org/pub/rocky/")
                  for line in html.splitlines():
                      match = re.search(r'href="([0-9]+)/"', line)
                      if match:
                          versions.append(match.group(1))
              except Exception:
                  pass
              return sorted(set(versions), key=int)

          def rocky_container_tags(majors, count=2):
              try:
                  data = fetch_text("https://quay.io/api/v1/repository/rockylinux/rockylinux/tag/?page_size=100&onlyActiveTags=true")
                  tags = {t.get("name") for t in json.loads(data).get("tags", []) if t.get("name")}
              except Exception:
                  tags = set()

              chosen = []
              for rel in reversed(majors):
                  if rel in tags and rel not in chosen:
                      chosen.append(rel)
                  if len(chosen) >= count:
                      break

              if not chosen:
                  chosen.append("9")
              while len(chosen) < count:
                  chosen.append(chosen[-1])

              return chosen[:count]

          def latest_rocky_releases(count=2):
              versions_sorted = rocky_version_list()
              if not versions_sorted:
                  return ["9"][:count]
              majors = sorted({v.split(".")[0] for v in versions_sorted}, key=int)
              trimmed = majors[-count:]
              return trimmed or [versions_sorted[-1].split(".")[0]]

          def latest_opensuse_leap():
              try:
                  data = fetch_text("https://download.opensuse.org/distribution/leap/")
                  versions = []
                  for line in data.splitlines():
                      match = re.search(r'href=\"([0-9]+(?:\\.[0-9]+)?)/\"', line)
                      if match:
                          versions.append(match.group(1))
                  if versions:
                      versions_sorted = sorted(versions, key=lambda v: [int(x) for x in v.split(".")])
                      return versions_sorted[-1]
              except Exception:
                  pass
              return "15.6"

          def latest_suse_bci():
              try:
                  data = fetch_text("https://registry.suse.com/v2/bci/bci-base/tags/list")
                  tags = json.loads(data).get("tags", [])
                  versions = []
                  for t in tags:
                      if all(ch.isdigit() or ch == "." for ch in t):
                          versions.append(t)
                  if versions:
                      versions_sorted = sorted(versions, key=lambda v: [int(x) for x in v.split(".")])
                      return versions_sorted[-1]
              except Exception:
                  pass
              return "15.6"

          def latest_alpine_release():
              try:
                  data = fetch_text("https://dl-cdn.alpinelinux.org/alpine/")
                  versions = []
                  for line in data.splitlines():
                      match = re.search(r'href="v([0-9]+\.[0-9]+)/"', line)
                      if match:
                          versions.append(match.group(1))
                  if versions:
                      versions_sorted = sorted(versions, key=lambda v: [int(x) for x in v.split(".")])
                      return versions_sorted[-1]
              except Exception:
                  pass
              return "3.21"

          ubuntu_stable = latest_ubuntu_non_lts()
          ubuntu_lts = latest_ubuntu_lts()
          debian_stable = debian_codename("stable")
          debian_oldstable = debian_codename("oldstable")
          fedora_release = latest_fedora_release()
          rocky_releases = latest_rocky_releases()
          rocky_latest = rocky_releases[-1]
          rocky_previous = rocky_releases[-2] if len(rocky_releases) > 1 else rocky_releases[-1]
          rocky_container_latest, rocky_container_previous = rocky_container_tags(rocky_releases, count=2)
          rocky_release = rocky_latest
          opensuse_leap = latest_opensuse_leap()
          suse_bci = latest_suse_bci()
          alpine_release = latest_alpine_release()

          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"ubuntu_stable={ubuntu_stable}\n")
              fh.write(f"ubuntu_lts={ubuntu_lts}\n")
              fh.write(f"debian_stable={debian_stable}\n")
              fh.write(f"debian_oldstable={debian_oldstable}\n")
              fh.write(f"fedora_release={fedora_release}\n")
              fh.write(f"rocky_release={rocky_release}\n")
              fh.write(f"rocky_previous={rocky_previous}\n")
              fh.write(f"rocky_latest={rocky_latest}\n")
              fh.write(f"rocky_container_latest={rocky_container_latest}\n")
              fh.write(f"rocky_container_previous={rocky_container_previous}\n")
              fh.write(f"rocky_releases={json.dumps(rocky_releases)}\n")
              fh.write(f"opensuse_leap={opensuse_leap}\n")
              fh.write(f"suse_bci={suse_bci}\n")
              fh.write(f"alpine_release={alpine_release}\n")
          PY

  build-deb-ubuntu-stable:
    name: Build .deb (Ubuntu Stable)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container: ubuntu:${{ needs.detect-versions.outputs.ubuntu_stable }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Prepare build environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y \
            git ca-certificates curl \
            build-essential debhelper \
            libpcap-dev fakeroot dpkg-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Extract version and generate changelog
        run: |
          set -euo pipefail
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          sed -i "1s/(.*)/(${NEIGHBOT_VERSION})/" debian/changelog

      - name: Fetch OUI database
        run: make oui.txt

      - name: Build .deb packages
        run: dpkg-buildpackage -us -uc -b -j"$(nproc)"

      - name: Collect artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/deb/ubuntu-stable
          shopt -s nullglob
          for pkg in ../*.deb; do
            name=$(dpkg-deb -f "$pkg" Package)
            ver=$(dpkg-deb -f "$pkg" Version)
            arch=$(dpkg-deb -f "$pkg" Architecture)
            cp "$pkg" "artifacts/deb/ubuntu-stable/${name}_${ver}~ubuntu-${{ needs.detect-versions.outputs.ubuntu_stable }}_${arch}.deb"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-ubuntu-stable
          path: artifacts/deb/ubuntu-stable/
          if-no-files-found: error

  build-deb-ubuntu-lts:
    name: Build .deb (Ubuntu LTS)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container: ubuntu:${{ needs.detect-versions.outputs.ubuntu_lts }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Prepare build environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y \
            git ca-certificates curl \
            build-essential debhelper \
            libpcap-dev fakeroot dpkg-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Extract version and generate changelog
        run: |
          set -euo pipefail
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          sed -i "1s/(.*)/(${NEIGHBOT_VERSION})/" debian/changelog

      - name: Fetch OUI database
        run: make oui.txt

      - name: Build .deb packages
        run: dpkg-buildpackage -us -uc -b -j"$(nproc)"

      - name: Collect artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/deb/ubuntu-lts
          shopt -s nullglob
          for pkg in ../*.deb; do
            name=$(dpkg-deb -f "$pkg" Package)
            ver=$(dpkg-deb -f "$pkg" Version)
            arch=$(dpkg-deb -f "$pkg" Architecture)
            cp "$pkg" "artifacts/deb/ubuntu-lts/${name}_${ver}~ubuntu-${{ needs.detect-versions.outputs.ubuntu_lts }}_${arch}.deb"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-ubuntu-lts
          path: artifacts/deb/ubuntu-lts/
          if-no-files-found: error

  build-deb-debian-stable:
    name: Build .deb (Debian Stable)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container: debian:${{ needs.detect-versions.outputs.debian_stable }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Prepare build environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y \
            git ca-certificates curl \
            build-essential debhelper \
            libpcap-dev fakeroot dpkg-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Extract version and generate changelog
        run: |
          set -euo pipefail
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          sed -i "1s/(.*)/(${NEIGHBOT_VERSION})/" debian/changelog

      - name: Fetch OUI database
        run: make oui.txt

      - name: Build .deb packages
        run: dpkg-buildpackage -us -uc -b -j"$(nproc)"

      - name: Collect artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/deb/debian-stable
          shopt -s nullglob
          for pkg in ../*.deb; do
            name=$(dpkg-deb -f "$pkg" Package)
            ver=$(dpkg-deb -f "$pkg" Version)
            arch=$(dpkg-deb -f "$pkg" Architecture)
            cp "$pkg" "artifacts/deb/debian-stable/${name}_${ver}~debian-${{ needs.detect-versions.outputs.debian_stable }}_${arch}.deb"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-debian-stable
          path: artifacts/deb/debian-stable/
          if-no-files-found: error

  build-deb-debian-oldstable:
    name: Build .deb (Debian Oldstable)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container: debian:${{ needs.detect-versions.outputs.debian_oldstable }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Prepare build environment
        run: |
          set -euo pipefail
          apt-get update
          apt-get install -y \
            git ca-certificates curl \
            build-essential debhelper \
            libpcap-dev fakeroot dpkg-dev

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Extract version and generate changelog
        run: |
          set -euo pipefail
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          sed -i "1s/(.*)/(${NEIGHBOT_VERSION})/" debian/changelog

      - name: Fetch OUI database
        run: make oui.txt

      - name: Build .deb packages
        run: dpkg-buildpackage -us -uc -b -j"$(nproc)"

      - name: Collect artifacts
        run: |
          set -euo pipefail
          mkdir -p artifacts/deb/debian-oldstable
          shopt -s nullglob
          for pkg in ../*.deb; do
            name=$(dpkg-deb -f "$pkg" Package)
            ver=$(dpkg-deb -f "$pkg" Version)
            arch=$(dpkg-deb -f "$pkg" Architecture)
            cp "$pkg" "artifacts/deb/debian-oldstable/${name}_${ver}~debian-${{ needs.detect-versions.outputs.debian_oldstable }}_${arch}.deb"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages-debian-oldstable
          path: artifacts/deb/debian-oldstable/
          if-no-files-found: error

  build-rpm-fedora:
    name: Build .rpm (Fedora)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container:
      image: fedora:${{ needs.detect-versions.outputs.fedora_release }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Install build tools
        run: |
          set -euo pipefail
          dnf install -y \
            git rpm-build make gcc \
            libpcap-devel systemd-rpm-macros \
            curl tar

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Prepare source tarball
        run: |
          set -euo pipefail
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          make oui.txt
          prefix="neighbot-${NEIGHBOT_VERSION}"
          git archive --format=tar --prefix="${prefix}/" HEAD > "${prefix}.tar"
          tar --append --file="${prefix}.tar" --transform="s|^|${prefix}/|" oui.txt
          gzip "${prefix}.tar"
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-$(rpm --eval '%{_topdir}')}"
          rm -rf "${RPM_TOPDIR}"
          mkdir -p "${RPM_TOPDIR}"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          cp "${prefix}.tar.gz" "${RPM_TOPDIR}/SOURCES/"
          sed "s/^Version:.*/Version: ${NEIGHBOT_VERSION}/" redhat/neighbot.spec > "${RPM_TOPDIR}/SPECS/neighbot.spec"
          printf 'RPM_TOPDIR=%s\n' "$RPM_TOPDIR" >> "$GITHUB_ENV"

      - name: Build RPM packages
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          rpmbuild --define "_topdir ${RPM_TOPDIR}" -ba "${RPM_TOPDIR}/SPECS/neighbot.spec"

      - name: Collect artifacts
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          mkdir -p artifacts/rpm/fedora-${{ needs.detect-versions.outputs.fedora_release }}
          find "${RPM_TOPDIR}/RPMS" -name '*.rpm' -print | while read -r pkg; do
            base=$(basename "$pkg")
            namever=${base%%.rpm}
            cp "$pkg" "artifacts/rpm/fedora-${{ needs.detect-versions.outputs.fedora_release }}/${namever}.fedora.${{ needs.detect-versions.outputs.fedora_release }}.rpm"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-fedora-${{ needs.detect-versions.outputs.fedora_release }}
          path: artifacts/rpm/fedora-${{ needs.detect-versions.outputs.fedora_release }}/
          if-no-files-found: error

  build-rpm-rocky:
    name: Build .rpm (Rocky ${{ needs.detect-versions.outputs.rocky_latest }})
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container:
      image: quay.io/rockylinux/rockylinux:${{ needs.detect-versions.outputs.rocky_container_latest }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Install build tools
        run: |
          set -euo pipefail
          # fix broken mirrorlist in container images
          if [ -d /etc/yum.repos.d ]; then
            sed -i 's|^mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/rocky*.repo 2>/dev/null || true
            sed -i 's|^#baseurl=http://dl.rockylinux.org|baseurl=http://dl.rockylinux.org|g' /etc/yum.repos.d/rocky*.repo 2>/dev/null || true
          fi
          pkgmgr=""
          if command -v dnf >/dev/null 2>&1; then
            pkgmgr="dnf"
          elif command -v microdnf >/dev/null 2>&1; then
            microdnf install -y dnf dnf-plugins-core
            pkgmgr="dnf"
          fi
          if [ -z "$pkgmgr" ]; then
            echo "No supported package manager found" >&2
            exit 1
          fi
          $pkgmgr install -y dnf-plugins-core epel-release || true
          dnf config-manager --set-enabled crb || true
          $pkgmgr install -y --allowerasing \
            git rpm-build make gcc \
            libpcap-devel systemd-rpm-macros \
            curl tar

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Prepare source tarball
        run: |
          set -euo pipefail
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          make oui.txt
          prefix="neighbot-${NEIGHBOT_VERSION}"
          git archive --format=tar --prefix="${prefix}/" HEAD > "${prefix}.tar"
          tar --append --file="${prefix}.tar" --transform="s|^|${prefix}/|" oui.txt
          gzip "${prefix}.tar"
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-$(rpm --eval '%{_topdir}')}"
          rm -rf "${RPM_TOPDIR}"
          mkdir -p "${RPM_TOPDIR}"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          cp "${prefix}.tar.gz" "${RPM_TOPDIR}/SOURCES/"
          sed "s/^Version:.*/Version: ${NEIGHBOT_VERSION}/" redhat/neighbot.spec > "${RPM_TOPDIR}/SPECS/neighbot.spec"
          printf 'RPM_TOPDIR=%s\n' "$RPM_TOPDIR" >> "$GITHUB_ENV"

      - name: Build RPM packages
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          rpmbuild --define "_topdir ${RPM_TOPDIR}" -ba "${RPM_TOPDIR}/SPECS/neighbot.spec"

      - name: Collect artifacts
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          mkdir -p artifacts/rpm/rocky-${{ needs.detect-versions.outputs.rocky_latest }}
          find "${RPM_TOPDIR}/RPMS" -name '*.rpm' -print | while read -r pkg; do
            base=$(basename "$pkg")
            namever=${base%%.rpm}
            cp "$pkg" "artifacts/rpm/rocky-${{ needs.detect-versions.outputs.rocky_latest }}/${namever}.rocky.${{ needs.detect-versions.outputs.rocky_latest }}.rpm"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-rocky-${{ needs.detect-versions.outputs.rocky_latest }}
          path: artifacts/rpm/rocky-${{ needs.detect-versions.outputs.rocky_latest }}/
          if-no-files-found: error

  build-rpm-rocky-previous:
    name: Build .rpm (Rocky ${{ needs.detect-versions.outputs.rocky_previous }})
    if: needs.detect-versions.outputs.rocky_previous != needs.detect-versions.outputs.rocky_latest
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container:
      image: quay.io/rockylinux/rockylinux:${{ needs.detect-versions.outputs.rocky_container_previous }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Install build tools
        run: |
          set -euo pipefail
          # fix broken mirrorlist in container images
          if [ -d /etc/yum.repos.d ]; then
            sed -i 's|^mirrorlist=|#mirrorlist=|g' /etc/yum.repos.d/rocky*.repo 2>/dev/null || true
            sed -i 's|^#baseurl=http://dl.rockylinux.org|baseurl=http://dl.rockylinux.org|g' /etc/yum.repos.d/rocky*.repo 2>/dev/null || true
          fi
          pkgmgr=""
          if command -v dnf >/dev/null 2>&1; then
            pkgmgr="dnf"
          elif command -v microdnf >/dev/null 2>&1; then
            microdnf install -y dnf dnf-plugins-core
            pkgmgr="dnf"
          fi
          if [ -z "$pkgmgr" ]; then
            echo "No supported package manager found" >&2
            exit 1
          fi
          $pkgmgr install -y dnf-plugins-core epel-release || true
          dnf config-manager --set-enabled crb || true
          $pkgmgr install -y --allowerasing \
            git rpm-build make gcc \
            libpcap-devel systemd-rpm-macros \
            curl tar

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Prepare source tarball
        run: |
          set -euo pipefail
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          make oui.txt
          prefix="neighbot-${NEIGHBOT_VERSION}"
          git archive --format=tar --prefix="${prefix}/" HEAD > "${prefix}.tar"
          tar --append --file="${prefix}.tar" --transform="s|^|${prefix}/|" oui.txt
          gzip "${prefix}.tar"
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-$(rpm --eval '%{_topdir}')}"
          rm -rf "${RPM_TOPDIR}"
          mkdir -p "${RPM_TOPDIR}"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          cp "${prefix}.tar.gz" "${RPM_TOPDIR}/SOURCES/"
          sed "s/^Version:.*/Version: ${NEIGHBOT_VERSION}/" redhat/neighbot.spec > "${RPM_TOPDIR}/SPECS/neighbot.spec"
          printf 'RPM_TOPDIR=%s\n' "$RPM_TOPDIR" >> "$GITHUB_ENV"

      - name: Build RPM packages
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          rpmbuild --define "_topdir ${RPM_TOPDIR}" -ba "${RPM_TOPDIR}/SPECS/neighbot.spec"

      - name: Collect artifacts
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          mkdir -p artifacts/rpm/rocky-${{ needs.detect-versions.outputs.rocky_previous }}
          find "${RPM_TOPDIR}/RPMS" -name '*.rpm' -print | while read -r pkg; do
            base=$(basename "$pkg")
            namever=${base%%.rpm}
            cp "$pkg" "artifacts/rpm/rocky-${{ needs.detect-versions.outputs.rocky_previous }}/${namever}.rocky.${{ needs.detect-versions.outputs.rocky_previous }}.rpm"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-rocky-${{ needs.detect-versions.outputs.rocky_previous }}
          path: artifacts/rpm/rocky-${{ needs.detect-versions.outputs.rocky_previous }}/
          if-no-files-found: error

  build-rpm-opensuse:
    name: Build .rpm (openSUSE Leap)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container:
      image: opensuse/leap:${{ needs.detect-versions.outputs.opensuse_leap }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Install build tools
        run: |
          set -euo pipefail
          zypper -n ref
          zypper -n install \
            git rpm-build make gcc \
            libpcap-devel systemd-rpm-macros \
            curl tar

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Prepare source tarball
        run: |
          set -euo pipefail
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          make oui.txt
          prefix="neighbot-${NEIGHBOT_VERSION}"
          git archive --format=tar --prefix="${prefix}/" HEAD > "${prefix}.tar"
          tar --append --file="${prefix}.tar" --transform="s|^|${prefix}/|" oui.txt
          gzip "${prefix}.tar"
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-$(rpm --eval '%{_topdir}')}"
          rm -rf "${RPM_TOPDIR}"
          mkdir -p "${RPM_TOPDIR}"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          cp "${prefix}.tar.gz" "${RPM_TOPDIR}/SOURCES/"
          sed "s/^Version:.*/Version: ${NEIGHBOT_VERSION}/" redhat/neighbot.spec > "${RPM_TOPDIR}/SPECS/neighbot.spec"
          printf 'RPM_TOPDIR=%s\n' "$RPM_TOPDIR" >> "$GITHUB_ENV"

      - name: Build RPM packages
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          rpmbuild --define "_topdir ${RPM_TOPDIR}" -ba "${RPM_TOPDIR}/SPECS/neighbot.spec"

      - name: Collect artifacts
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          mkdir -p artifacts/rpm/opensuse-${{ needs.detect-versions.outputs.opensuse_leap }}
          find "${RPM_TOPDIR}/RPMS" -name '*.rpm' -print | while read -r pkg; do
            base=$(basename "$pkg")
            namever=${base%%.rpm}
            cp "$pkg" "artifacts/rpm/opensuse-${{ needs.detect-versions.outputs.opensuse_leap }}/${namever}.opensuse.${{ needs.detect-versions.outputs.opensuse_leap }}.rpm"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-opensuse-${{ needs.detect-versions.outputs.opensuse_leap }}
          path: artifacts/rpm/opensuse-${{ needs.detect-versions.outputs.opensuse_leap }}/
          if-no-files-found: error

  build-rpm-suse:
    name: Build .rpm (SUSE BCI)
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container:
      image: registry.suse.com/bci/bci-base:${{ needs.detect-versions.outputs.suse_bci }}
    defaults:
      run:
        shell: bash
    steps:
      - name: Install build tools
        run: |
          set -euo pipefail
          ver="${{ needs.detect-versions.outputs.suse_bci }}"
          if command -v SUSEConnect >/dev/null 2>&1; then
            SUSEConnect -p "sle-module-development-tools/${ver}/x86_64" || true
            SUSEConnect -p "PackageHub/${ver}/x86_64" || true
          fi
          zypper -n ref
          zypper -n install \
            git rpm-build make gcc \
            libpcap-devel systemd-rpm-macros \
            curl tar

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Prepare source tarball
        run: |
          set -euo pipefail
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          make oui.txt
          prefix="neighbot-${NEIGHBOT_VERSION}"
          git archive --format=tar --prefix="${prefix}/" HEAD > "${prefix}.tar"
          tar --append --file="${prefix}.tar" --transform="s|^|${prefix}/|" oui.txt
          gzip "${prefix}.tar"
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-$(rpm --eval '%{_topdir}')}"
          rm -rf "${RPM_TOPDIR}"
          mkdir -p "${RPM_TOPDIR}"/{BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS}
          cp "${prefix}.tar.gz" "${RPM_TOPDIR}/SOURCES/"
          sed "s/^Version:.*/Version: ${NEIGHBOT_VERSION}/" redhat/neighbot.spec > "${RPM_TOPDIR}/SPECS/neighbot.spec"
          printf 'RPM_TOPDIR=%s\n' "$RPM_TOPDIR" >> "$GITHUB_ENV"

      - name: Build RPM packages
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          rpmbuild --define "_topdir ${RPM_TOPDIR}" -ba "${RPM_TOPDIR}/SPECS/neighbot.spec"

      - name: Collect artifacts
        run: |
          set -euo pipefail
          RPM_TOPDIR="${RPMBUILD_TOPDIR:-/tmp/rpmbuild}"
          mkdir -p artifacts/rpm/suse-${{ needs.detect-versions.outputs.suse_bci }}
          find "${RPM_TOPDIR}/RPMS" -name '*.rpm' -print | while read -r pkg; do
            base=$(basename "$pkg")
            namever=${base%%.rpm}
            cp "$pkg" "artifacts/rpm/suse-${{ needs.detect-versions.outputs.suse_bci }}/${namever}.suse.${{ needs.detect-versions.outputs.suse_bci }}.rpm"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rpm-packages-suse-${{ needs.detect-versions.outputs.suse_bci }}
          path: artifacts/rpm/suse-${{ needs.detect-versions.outputs.suse_bci }}/
          if-no-files-found: error

  build-apk-alpine:
    name: Build .apk (Alpine ${{ needs.detect-versions.outputs.alpine_release }})
    runs-on: ubuntu-latest
    needs:
      - detect-versions
    container:
      image: alpine:${{ needs.detect-versions.outputs.alpine_release }}
    defaults:
      run:
        shell: sh
    steps:
      - name: Install build tools
        run: |
          apk add --no-cache \
            git build-base abuild libpcap-dev linux-headers curl sudo

      - name: Set up abuild user
        run: |
          adduser -D builder
          addgroup builder abuild
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
          mkdir -p /home/builder/.abuild
          openssl genrsa -out /home/builder/.abuild/builder.rsa 2048
          openssl rsa -in /home/builder/.abuild/builder.rsa \
            -pubout -out /home/builder/.abuild/builder.rsa.pub
          cp /home/builder/.abuild/builder.rsa.pub /etc/apk/keys/
          printf 'PACKAGER_PRIVKEY="/home/builder/.abuild/builder.rsa"\n' \
            > /home/builder/.abuild/abuild.conf
          chown -R builder:builder /home/builder

      - name: Mark workspace as safe for git
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.ref || github.ref }}

      - name: Build .apk package
        run: |
          set -eu
          NEIGHBOT_VERSION=$(grep '#define NEIGHBOT_VERSION' neighbot.h | sed 's/.*"\(.*\)"/\1/')
          make oui.txt
          prefix="neighbot-${NEIGHBOT_VERSION}"
          git archive --format=tar --prefix="${prefix}/" HEAD > "${prefix}.tar"
          tar --append --file="${prefix}.tar" --transform="s|^|${prefix}/|" oui.txt
          gzip "${prefix}.tar"

          mkdir -p /home/builder/build
          cp alpine/APKBUILD /home/builder/build/
          sed -i "s/^pkgver=.*/pkgver=${NEIGHBOT_VERSION}/" /home/builder/build/APKBUILD
          cp "${prefix}.tar.gz" /home/builder/build/
          chown -R builder:builder /home/builder/build

          cd /home/builder/build
          su builder -c "abuild checksum"
          su builder -c "abuild -r"

      - name: Collect artifacts
        run: |
          set -eu
          ALPINE_VER="${{ needs.detect-versions.outputs.alpine_release }}"
          mkdir -p artifacts/apk
          find /home/builder/packages -name '*.apk' -print | while read -r pkg; do
            base=$(basename "$pkg")
            namever=${base%%.apk}
            cp "$pkg" "artifacts/apk/${namever}.alpine.${ALPINE_VER}.apk"
          done

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-packages-alpine-${{ needs.detect-versions.outputs.alpine_release }}
          path: artifacts/apk/
          if-no-files-found: error

  publish:
    name: Upload Release Assets
    if: ${{ !failure() && !cancelled() }}
    runs-on: ubuntu-latest
    needs:
      - resolve-tag
      - detect-versions
      - build-deb-ubuntu-stable
      - build-deb-ubuntu-lts
      - build-deb-debian-stable
      - build-deb-debian-oldstable
      - build-rpm-fedora
      - build-rpm-rocky
      - build-rpm-rocky-previous
      - build-rpm-opensuse
      - build-rpm-suse
      - build-apk-alpine
    steps:
      - name: Download .deb artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: deb-packages-*
          path: release-assets/deb
          merge-multiple: true

      - name: Download .rpm artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: rpm-packages-*
          path: release-assets/rpm
          merge-multiple: true

      - name: Download .apk artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: apk-packages-*
          path: release-assets/apk
          merge-multiple: true

      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.resolve-tag.outputs.tag }}
          files: |
            release-assets/deb/*.deb
            release-assets/rpm/*.rpm
            release-assets/apk/*.apk
